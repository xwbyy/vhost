<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0d6efd">
  <title>Terminal - <%= appName %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.3.0/css/xterm.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="/"><i class="bi bi-cloud-arrow-up-fill me-2"></i><%= appName %></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="/"><i class="bi bi-house-door me-1"></i>Beranda</a></li>
          <li class="nav-item"><a class="nav-link" href="/deploy"><i class="bi bi-rocket-takeoff me-1"></i>Deploy</a></li>
          <li class="nav-item"><a class="nav-link" href="/apps"><i class="bi bi-grid me-1"></i>Aplikasi</a></li>
          <li class="nav-item"><a class="nav-link active" href="/terminal"><i class="bi bi-terminal me-1"></i>Terminal</a></li>
          <% if (typeof user !== 'undefined' && user && user.is_admin === 'true') { %>
          <li class="nav-item"><a class="nav-link" href="/dbadmin"><i class="bi bi-gear me-1"></i>Admin</a></li>
          <% } %>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item"><button class="btn btn-link nav-link" id="themeToggle"><i class="bi bi-moon-stars"></i></button></li>
          <% if (typeof user !== 'undefined' && user) { %>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
              <span class="badge <%= user.tier === 'vip' ? 'bg-warning text-dark' : 'bg-secondary' %> me-2"><%= user.tier === 'vip' ? 'VIP' : 'FREE' %></span>
              <span class="d-none d-md-inline"><%= user.username %></span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="/profile"><i class="bi bi-person me-2"></i>Profil</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
            </ul>
          </li>
          <% } %>
        </ul>
      </div>
    </div>
  </nav>

  <main class="main-content">
    <div class="container-fluid py-3">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
              <div>
                <h5 class="mb-0"><i class="bi bi-terminal me-2"></i>Live Terminal</h5>
              </div>
              <div class="d-flex gap-2 flex-wrap">
                <select id="appSelect" class="form-select form-select-sm" style="width: auto;">
                  <option value="">-- Pilih Aplikasi --</option>
                  <% if (typeof apps !== 'undefined') { %>
                  <% apps.forEach(function(app) { %>
                  <option value="<%= app.name %>"><%= app.name %></option>
                  <% }); %>
                  <% } %>
                </select>
                <button id="btnConnect" class="btn btn-sm btn-success">
                  <i class="bi bi-play-circle me-1"></i>Connect
                </button>
                <button id="btnClear" class="btn btn-sm btn-outline-secondary">
                  <i class="bi bi-trash me-1"></i>Clear
                </button>
                <button id="btnFullscreen" class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-arrows-fullscreen"></i>
                </button>
              </div>
            </div>
            <div class="card-body p-0">
              <div id="terminal-container" style="height: 60vh; min-height: 300px;"></div>
            </div>
            <div class="card-footer">
              <div class="row align-items-center">
                <div class="col-12 col-md-6 mb-2 mb-md-0">
                  <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-chevron-right"></i></span>
                    <input type="text" id="cmdInput" class="form-control" placeholder="Ketik perintah..." disabled>
                    <button id="btnSend" class="btn btn-primary" disabled>Kirim</button>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="d-flex gap-2 flex-wrap justify-content-md-end">
                    <button class="btn btn-sm btn-outline-info quick-cmd" data-cmd="npm start">npm start</button>
                    <button class="btn btn-sm btn-outline-info quick-cmd" data-cmd="node index.js">node index.js</button>
                    <button class="btn btn-sm btn-outline-warning quick-cmd" data-cmd="npm install">npm install</button>
                    <button class="btn btn-sm btn-outline-secondary quick-cmd" data-cmd="ls -la">ls -la</button>
                    <button class="btn btn-sm btn-outline-secondary quick-cmd" data-cmd="cat package.json">package.json</button>
                    <button class="btn btn-sm btn-outline-danger quick-cmd" data-cmd="Ctrl+C">Stop</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-12 col-md-6 mb-3">
          <div class="card h-100">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-journal-text me-2"></i>Output Logs</h6>
            </div>
            <div class="card-body">
              <div id="outputLogs" class="log-container bg-dark text-light p-2 rounded" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                <span class="text-muted">Pilih aplikasi dan klik Connect untuk melihat logs...</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6 mb-3">
          <div class="card h-100">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Error Logs</h6>
            </div>
            <div class="card-body">
              <div id="errorLogs" class="log-container bg-dark text-danger p-2 rounded" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                <span class="text-muted">Pilih aplikasi dan klik Connect untuk melihat error logs...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <% if (typeof user !== 'undefined' && user && user.tier === 'free') { %>
      <div class="alert alert-warning" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Free User:</strong> Terminal terbatas. Upgrade ke VIP untuk akses penuh termasuk SSH dan custom commands.
      </div>
      <% } %>
    </div>
  </main>

  <footer class="footer mt-auto py-3 bg-light">
    <div class="container text-center">
      <span class="text-muted"><i class="bi bi-code-slash me-1"></i><%= appName %> v2.0.0</span>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script src="/js/app.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const terminalContainer = document.getElementById('terminal-container');
    const cmdInput = document.getElementById('cmdInput');
    const btnConnect = document.getElementById('btnConnect');
    const btnSend = document.getElementById('btnSend');
    const btnClear = document.getElementById('btnClear');
    const btnFullscreen = document.getElementById('btnFullscreen');
    const appSelect = document.getElementById('appSelect');
    const outputLogs = document.getElementById('outputLogs');
    const errorLogs = document.getElementById('errorLogs');

    let terminal = null;
    let ws = null;
    let connected = false;

    if (typeof Terminal !== 'undefined') {
      terminal = new Terminal({
        cursorBlink: true,
        fontSize: 14,
        fontFamily: 'Menlo, Monaco, "Courier New", monospace',
        theme: {
          background: '#1e1e1e',
          foreground: '#d4d4d4',
          cursor: '#d4d4d4',
          selection: '#264f78',
          black: '#000000',
          red: '#cd3131',
          green: '#0dbc79',
          yellow: '#e5e510',
          blue: '#2472c8',
          magenta: '#bc3fbc',
          cyan: '#11a8cd',
          white: '#e5e5e5'
        }
      });
      terminal.open(terminalContainer);
      terminal.write('Welcome to Hosting Mandiri Terminal\r\n');
      terminal.write('Pilih aplikasi dan klik Connect untuk mulai.\r\n\r\n');
    }

    btnConnect.addEventListener('click', function() {
      const appName = appSelect.value;
      if (!appName) {
        alert('Pilih aplikasi terlebih dahulu');
        return;
      }

      if (connected) {
        disconnectWS();
        return;
      }

      connectWS(appName);
    });

    function connectWS(appName) {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}/ws/terminal/${appName}`);

      ws.onopen = function() {
        connected = true;
        btnConnect.innerHTML = '<i class="bi bi-stop-circle me-1"></i>Disconnect';
        btnConnect.classList.remove('btn-success');
        btnConnect.classList.add('btn-danger');
        cmdInput.disabled = false;
        btnSend.disabled = false;
        terminal.write(`\r\n\x1b[32mConnected to ${appName}\x1b[0m\r\n`);
      };

      ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.type === 'output') {
          terminal.write(data.content);
          appendLog(outputLogs, data.content);
        } else if (data.type === 'error') {
          terminal.write(`\x1b[31m${data.content}\x1b[0m`);
          appendLog(errorLogs, data.content, true);
        } else if (data.type === 'logs') {
          if (data.out) {
            outputLogs.innerHTML = '';
            data.out.split('\n').forEach(line => appendLog(outputLogs, line));
          }
          if (data.error) {
            errorLogs.innerHTML = '';
            data.error.split('\n').forEach(line => appendLog(errorLogs, line, true));
          }
        }
      };

      ws.onclose = function() {
        disconnectWS();
        if (terminal) terminal.write('\r\n\x1b[33mDisconnected\x1b[0m\r\n');
      };

      ws.onerror = function(error) {
        if (terminal) terminal.write(`\r\n\x1b[31mConnection error\x1b[0m\r\n`);
      };
    }

    function disconnectWS() {
      if (ws) {
        ws.close();
        ws = null;
      }
      connected = false;
      btnConnect.innerHTML = '<i class="bi bi-play-circle me-1"></i>Connect';
      btnConnect.classList.remove('btn-danger');
      btnConnect.classList.add('btn-success');
      cmdInput.disabled = true;
      btnSend.disabled = true;
    }

    function sendCommand(cmd) {
      if (ws && connected) {
        ws.send(JSON.stringify({ type: 'command', command: cmd }));
        terminal.write(`\r\n$ ${cmd}\r\n`);
      }
    }

    btnSend.addEventListener('click', function() {
      const cmd = cmdInput.value.trim();
      if (cmd) {
        sendCommand(cmd);
        cmdInput.value = '';
      }
    });

    cmdInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        btnSend.click();
      }
    });

    btnClear.addEventListener('click', function() {
      if (terminal) {
        terminal.clear();
      }
      outputLogs.innerHTML = '';
      errorLogs.innerHTML = '';
    });

    btnFullscreen.addEventListener('click', function() {
      if (terminalContainer.requestFullscreen) {
        terminalContainer.requestFullscreen();
      }
    });

    document.querySelectorAll('.quick-cmd').forEach(btn => {
      btn.addEventListener('click', function() {
        const cmd = this.dataset.cmd;
        if (cmd === 'Ctrl+C') {
          if (ws && connected) {
            ws.send(JSON.stringify({ type: 'signal', signal: 'SIGINT' }));
          }
        } else {
          sendCommand(cmd);
        }
      });
    });

    function appendLog(container, text, isError = false) {
      const line = document.createElement('div');
      line.textContent = text;
      if (isError) line.classList.add('text-danger');
      container.appendChild(line);
      container.scrollTop = container.scrollHeight;
    }
  });
  </script>
</body>
</html>
